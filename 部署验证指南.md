# 🚀 **部署验证指南：完成两步"收口"**

## ✅ **第一步：设置环境变量**

### **在Netlify控制台中设置：**

1. **登录Netlify控制台**
2. **选择你的项目**：`unrivaled-pavlova-43ddb4`
3. **进入设置**：Site settings → Environment variables
4. **添加环境变量**：

```
Key: CONFIG_ENC_KEY
Value: ba5b32d86caf37ba79e4bf41a0ae636f82dcbf01e66890f807dca7b3f570555b
Context: Production ✅
Scopes: Functions ✅
```

**重要设置：**
- ✅ **Context**：选择 **Production**（其他上下文可以留空）
- ✅ **Scopes**：勾选 **Functions**（Build/Runtime可选）
- ✅ **Secret**：可选，用于UI隐藏值
- ⚠️ **注意**：值里不要有多余空格/换行

### **可选：设置其他环境变量**

```
FEISHU_APP_ID = [你的飞书App ID]
FEISHU_APP_SECRET = [你的飞书App Secret]
FEISHU_TABLE_ID = [你的飞书Table ID]
```

## 🔄 **第二步：重新部署**

### **Clear cache and deploy：**

1. **Netlify控制台** → **Deploys**
2. **点击**：**Trigger deploy** → **Clear cache and deploy site**
3. **等待部署完成**

> **重要**：环境变量变更只有重新部署后，Functions才会读到。

## 🧪 **第三步：验证环境变量**

### **检查health端点：**

```bash
curl https://unrivaled-pavlova-43ddb4.netlify.app/.netlify/functions/health
```

**期望结果：**
```json
{
  "ok": true,
  "config": {
    "hasAppId": true,
    "hasAppSecret": true,
    "hasTableId": true,
    "hasEncKey": true
  }
}
```

### **浏览器验证：**

1. **打开**：https://unrivaled-pavlova-43ddb4.netlify.app/.netlify/functions/health
2. **期望看到**：`hasEncKey: true`

## 🔧 **第四步：重新保存个人配置**

### **由于加密密钥变更，需要重新保存配置：**

1. **登录站点**：使用Netlify Identity
2. **访问配置页面**：https://unrivaled-pavlova-43ddb4.netlify.app/config
3. **填写配置**：
   - App ID
   - App Secret
   - 多维表格链接
4. **点击"保存配置"**

### **如果遇到 `enc_key_mismatch` 错误：**

1. **打开浏览器控制台**（F12）
2. **执行清除命令**：
   ```javascript
   extractor.clearUserConfig().then(result => {
       if (result.ok) {
           console.log('配置已清除，请重新保存配置');
       }
   });
   ```
3. **重新保存配置**

## 🎯 **第五步：完整测试流程**

### **1. 检查配置状态：**
```javascript
extractor.checkConfigStatus().then(status => {
    console.log('配置状态:', status);
});
```

### **2. 测试提取功能：**
1. **输入测试URL**：https://example.com
2. **点击"开始提取"**
3. **期望结果**：成功提取并写入飞书

## 🚨 **故障排除**

### **如果仍然出现错误：**

1. **检查health端点**：确认 `hasEncKey: true`
2. **查看错误类型**：
   - `auth_required`：需要登录
   - `user_config_missing`：未保存配置
   - `enc_key_mismatch`：加密密钥不匹配
   - `missing_config`：环境变量未设置

3. **查看Functions日志**：
   - Netlify控制台 → Functions → 查看日志
   - 搜索 `requestId` 定位具体错误

## 🎉 **成功标志**

当看到以下结果时，说明部署成功：

- ✅ **health端点**：`hasEncKey: true`
- ✅ **配置保存**：显示"配置保存成功！个人配置已更新"
- ✅ **提取功能**：成功提取并写入飞书
- ✅ **错误处理**：不再出现500错误，而是具体错误提示

## 📋 **快速自测清单**

- [ ] 环境变量已设置（`CONFIG_ENC_KEY`）
- [ ] 已重新部署（Clear cache and deploy）
- [ ] health端点返回 `hasEncKey: true`
- [ ] 已登录并重新保存配置
- [ ] 提取功能正常工作

**完成这些步骤后，你的系统就彻底稳定了！** 🚀
